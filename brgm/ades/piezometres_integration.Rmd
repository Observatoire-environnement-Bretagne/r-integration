---
title: "Integration des données piezometriques"
output: html_notebook
params:
  reseau_piezo: '0400000020'
  date_debut: 2021-05-01
  date_fin: 2021-05-31
  pagination: 100
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(DBI) # pour les connexions aux BDD
library(RPostgreSQL) # driver postgres
library(RMariaDB) # driver
library(RMySQL)
library(lubridate) # calcul sur les dates

library(httr) #
library(jsonlite)

```

```{r fonctions}
api_reponse <- function(request) {
  
case_when(request$status_code==200 ~ "OK, tous les résultats sont présents dans la réponse",
          request$status_code==206 ~ "OK, il reste des résultats",
          request$status_code==400 ~ "Requête incorrecte",
            TRUE ~ "Autre réponse")
}


get_hubeau <- function(path, query) {
  
  response <- GET(url = path, query = query) %>% 
  content(as = "text", encoding = "UTF-8") %>%
  fromJSON(flatten = TRUE)
  
data = response$data

if(response$count > query$size) {
  
pages <- ceiling(response$count/query$size)

pb <- winProgressBar(title = "Récupération des chroniques", min = 0,
                     max = pages, width = 300)

for(i in 2:pages){
  
  query$page <- i
  
  response_i <- GET(url = path, query = query) %>% 
  content(as = "text", encoding = "UTF-8") %>%
  fromJSON(flatten = TRUE)
  
data <- rbind(data, response_i$data)

setWinProgressBar(pb, i, title=paste( round(i/pages*100, 0), "% chargé"))

}

close(pb)

}

return(data)
  }


```


```{r connexion_bd}

con_mysql_local <- dbConnect(odbc::odbc(), .connection_string = "
                           Driver={MySQL ODBC 8.0 Unicode Driver};
                           user = root;
                           password = root;
                           database = oeb_tbi;
                           host = localhost",
    timeout = 10)

dbListTables(con_mysql_local) # Lister les tables de la base
```

```{r piezometres}

db_piezometres <- tbl(con_mysql_local, "oeb_tbi_variationnappe_pz")

db_piezometres %>% tally() #56 piezometres

liste_codes_bss <- db_piezometres %>% collect() %>%
  summarise(Code_national_BSS = str_flatten(Code_national_BSS, collapse = ","))

```

```{r hubeau}

# Récupération des infos sur les stations de mesure

query_stations = list(
  code_bss=liste_codes_bss,
  format='json',
  size=params$pagination
  )

hubeau_stations <- get_hubeau(path = "https://hubeau.eaufrance.fr/api/v1/niveaux_nappes/stations?", query = query_stations)

# Récupération des mesures

query_chroniques = list(
                 code_bss = liste_codes_bss,
                 format = 'json',
                 size = params$pagination,
                 date_debut_mesure = params$date_debut,
                 date_fin_mesure = params$date_fin)

hubeau_chroniques <- get_hubeau(path = "https://hubeau.eaufrance.fr/api/v1/niveaux_nappes/chroniques?", query=query_chroniques)
```

Réponse de Hub'eau :

- Stations : 
- Chroniques : 

