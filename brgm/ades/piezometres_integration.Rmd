---
title: "Integration des données piezometriques"
output: html_notebook
params:
  reseau_piezo: '0400000020'
  date_debut: 2021-05-01
  date_fin: 2021-05-31
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(DBI) # pour les connexions aux BDD
library(RPostgreSQL) # driver postgres
library(RMariaDB) # driver
library(RMySQL)
library(lubridate) # calcul sur les dates

library(httr) #
library(jsonlite)

```

```{r fonctions}
api_reponse <- function(request) {
  
case_when(request$status_code==200 ~ "OK, tous les résultats sont présents dans la réponse",
          request$status_code==206 ~ "OK, il reste des résultats",
          request$status_code==400 ~ "Requête incorrecte",
            TRUE ~ "Autre réponse")
}
```


```{r connexion_bd}

con_mysql_local <- dbConnect(odbc::odbc(), .connection_string = "
                           Driver={MySQL ODBC 8.0 Unicode Driver};
                           user = root;
                           password = root;
                           database = oeb_tbi;
                           host = localhost",
    timeout = 10)

dbListTables(con_mysql_local) # Lister les tables de la base
```

```{r piezometres}

db_piezometres <- tbl(con_mysql_local, "oeb_tbi_variationnappe_pz")

db_piezometres %>% tally() #56 piezometres

liste_codes_bss <- db_piezometres %>% collect() %>%
  summarise(Code_national_BSS = str_flatten(Code_national_BSS, collapse = ","))

```

```{r hubeau}

# Récupération des infos sur les stations de mesure
path_stations <- "https://hubeau.eaufrance.fr/api/v1/niveaux_nappes/stations?"
request_stations <- GET(url = path_stations, 
               query = list(
                 code_bss=liste_codes_bss,
                 format='json',
                 size='20000')
               )

response_stations <- content(request_stations, as = "text", encoding = "UTF-8") %>%
  fromJSON(flatten = TRUE)

hubeau_stations <- response_stations$data


# Récupération des mesures
path_chroniques <- "https://hubeau.eaufrance.fr/api/v1/niveaux_nappes/chroniques?"
request_chroniques <- GET(url = path_chroniques, 
               query = list(
                 code_bss = liste_codes_bss,
                 format = 'json',
                 size = '20000',
                 date_debut = params$date_debut,
                 date_fin = params$date_fin)
               )

response_chroniques <- content(request_chroniques, as = "text", encoding = "UTF-8") %>%
  fromJSON(flatten = TRUE)

hubeau_chroniques <- response_chroniques$data
```

Réponse de Hub'eau :

- Stations : `r api_reponse(request_stations)`
- Chroniques : `r api_reponse(request_chroniques)`

