---
title: "Integration des données qualitometriques"
output: html_notebook
params:
  codes_reseau: '0000000028,0400000020,0400000124,0400000127,0400000128,0400000192,0400003006,0400001001,0400001002,0400000201'
  num_departement: '22,29,35,56,50,44,49,53'
  date_debut: 2020-01-01
  date_fin: 2020-12-31
  pagination: 5000
---

# Objet

Intégration des données des qualitomètres (suivi de la qualité des eaux souterraines)

Source : ADES

CdParametre : 1340 (Nitrates)
CdSupport : 3 (Eau)
CdMilieu : 4 (Eaux souterraines)
CdTypeSiteSurv : 4 (Point d'eau (E. souterraine))
574 sites de surveillance

Réseaux : RNSISEAU, FRGSOS, FRGSOO et RBESOUNO3LB

DC concernés :
BRETAGNE : 0000000028, **0400000020**, 0400000124, 0400000127, 0400000128, **0400000192**, 0400003006 , 0400001001,0400001002
PdL : 0000000028, 0400000124, 0400000127, 0400000128, **0400000201**,0400001001,0400001002, 0400003006

Perimetre : Depuis 1995

# Informations sur la donnée

Concernant la mise à jour des données santé, elle est effectuée dans Ades deux fois par an, une fois en début d’année avec les données du 1er semestre de l’année précédente et une seconde fois, en aout ou début septembre avec celles du 2nd semestre de l’année précédente.

> Les données source sont issues d'un export de la BDD ADES réalisé en septembre 2015. Les stations sont rattachées aux réseaux RNSISEAU, FRGSOS, FRGSOO et RBESOUNO3LB. Pour chaque point d’eau, la concentration maximale (exprimée en mg/l) en nitrate correspond à la valeur maximale des analyses dans le domaine de validité ou inférieure au seuil de quantification, pour la substance considérée. 
En application des règles de calcul du SEQ-Eaux souterraines – Classes de qualité par altération (code couleur - valeurs seuils (maximale)) :
- Rouge - Mauvais : [max] supérieur ou égal à 100 mg/l
- Orange - Médiocre : 50 inférieur ou égal à [max] inférieur à 100 mg/l
- Jaune - Moyen : 20 inférieur ou égal à [max] inférieur à 50mg/l
- Vert - Bon : 10 inférieur ou égal à [max] inférieur à 20 mg/l
- Bleu - Très bon : [max] inférieur à 10 mg/l

Cf carte DREAL

http://www.bretagne.developpement-durable.gouv.fr/IMG/pdf/eau_en_bretagne_2014_4.pdf

>Pour la région Bretagne, le suivi de 54 stations en 2014 montre une situation globalement stable depuis 2007. Les ¾ des stations suivies respectent le bon état (<50 mg/l). On observe toutefois une situation relativement dégradée sur la partie nord du Finistère et le Trégor où certaines des valeurs moyennes des concentrations observées dépassent 100 mg/l.

# Données à bancariser

Séries par entité géographique (site) :

- Concentration minimale, maximale, moyenne (annuelle)
- Concentration (journalière)
- Nombre de prélèvements > 50mg/l
- Nombre de prélèvements
- Station en bon état (DCE)
- Stations suivies
- Stations évaluées (DCE)

```{r setup}
knitr::opts_chunk$set(echo = TRUE)
library(config) # Utilisation d'un fichier de configuration, cf  https://db.rstudio.com/best-practices/managing-credentials/#stored-in-a-file-with-config
library(tidyverse)
library(DBI) # pour les connexions aux BDD
library(RPostgreSQL) # driver postgres
library(RMariaDB) # driver
library(RMySQL)
library(lubridate) # calcul sur les dates

library(httr) #
library(jsonlite)

# Fonction pour traduire la réponse de l'API
api_reponse <- function(request) {
  
case_when(request$status_code==200 ~ "OK, tous les résultats sont présents dans la réponse",
          request$status_code==206 ~ "OK, il reste des résultats",
          request$status_code==400 ~ "Requête incorrecte",
            TRUE ~ "Autre réponse")
}

# Fonction pour requêter l'API Hub'Eau

get_hubeau <- function(path, query) {
  
  response <- GET(url = path, query = query) %>% 
  content(as = "text", encoding = "UTF-8") %>%
  fromJSON(flatten = TRUE)
  
data = response$data # Le jeu de données est dans l'objet "data"

if(response$count > query$size) { # Si la taille de page est plus petite que le nb de résultats, faire une boucle pour les pages suivantes
  
pages <- ceiling(response$count/query$size)

# Affichage d'une barre de progression
pb <- winProgressBar(title = "Récupération des données", min = 0,
                     max = pages, width = 300)

for(i in 2:pages){
  
  query$page <- i
  
  response_i <- GET(url = path, query = query) %>% 
  content(as = "text", encoding = "UTF-8") %>%
  fromJSON(flatten = TRUE)

data <- rbind(data, response_i$data) # Concaténation des lignes récupérées

setWinProgressBar(pb, i, title=paste( round(i/pages*100, 0), "% chargé")) # Avancement de la barre de progression

} # Fin boucle for

close(pb)

} # Fin if

return(data)
  } # Fin get_hubeau
```


```{r connexion_bd}

# conf <- config::get("mysql_local")
# 
# con_mysql_local <- dbConnect(odbc::odbc(),
#                              Driver=conf$driver,
#                              host = conf$host,
#                              UID = conf$uid,
#                              PWD = conf$pwd,
#                              port = conf$port,
#                              timeout = 10,
#                              database = "oeb_tbi",
#                              encoding = "latin1")

con_mysql_oeb <- dbConnect(RMariaDB::MariaDB(), default.file = '../../.my.cnf', groups="mysql_oeb",
dbname = "eau_tbi")

dbListTables(con_mysql_oeb) # Lister les tables de la base
```

```{r qualitometres}
# Recupération de la liste des piézomètres du réseau breton dans la base de données

db_qualitometres <- tbl(con_mysql_oeb, "oeb_tbi_nitrate_nappe") # Lecture de la table des piezometres

db_qualitometres %>% distinct(CdSiteSurv) %>%tally() #574 qualitometres

liste_codes_bss <- db_qualitometres %>% distinct(CdSiteSurv) %>% collect() %>%
  summarise(Code_national_BSS = str_flatten(CdSiteSurv, collapse = ",")) # Liste des piezometres pour la requete

```



```{r hubeau}

# Récupération des infos sur les stations de mesure

#liste_codes_bss <- c('03462X0036/P')

# Liste des paramètres de la requête
query_stations = list(
  num_departement=params$num_departement,
  format='json',
  size=params$pagination
  )

# Requête des stations
hubeau_stations <- get_hubeau(path = "https://hubeau.eaufrance.fr/api/v1/qualite_nappes/stations?", query = query_stations)

# Récupération des chroniques

# Liste des paramètres de la requête
query_analyses = list(
                 codes_reseau=params$codes_reseau,
                 format = 'json',
                 size = params$pagination,
                 date_debut_mesure = params$date_debut,
                 date_fin_mesure = as.Date(params$date_fin)-1)

# Requête des analyses
hubeau_analyses <- get_hubeau(path = "https://hubeau.eaufrance.fr/api/v1/qualite_nappes/analyses?", query=query_analyses)
```

```{r}
hubeau_stations
```


